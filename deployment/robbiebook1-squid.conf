# RobbieBook1 Squid Proxy Configuration
# Routes through VPN to Aurora Town (always-on with fixed IP)
# Aggressive caching for offline capability

# Listen on local port
http_port 3128

# Cache directory and settings
cache_dir ufs /usr/local/var/cache/squid 2048 16 256
cache_mem 512 MB
maximum_object_size 100 MB
maximum_object_size_in_memory 10 MB

# Cache peer - route through Aurora Town's Squid via VPN
cache_peer 10.0.0.10 parent 3128 0 no-query default
never_direct allow all

# ACLs for local networks
acl localnet src 127.0.0.1/32
acl localnet src 192.168.0.0/16
acl aurora_mesh src 10.0.0.0/24

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

# Access control
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow aurora_mesh
http_access allow localhost
http_access deny all

# Aggressive caching for offline capability
# Cache everything for 7 days by default
refresh_pattern . 0 40% 10080

# Images - cache for 30 days
refresh_pattern -i \.(gif|png|jpg|jpeg|ico|svg|webp)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload

# CSS/JS - cache for 10 days
refresh_pattern -i \.(css|js|woff|woff2|ttf|eot)$ 1440 40% 40320 reload-into-ims

# API responses - cache for 7 days
refresh_pattern ^https://api\. 0 20% 10080

# Specific API caching rules
refresh_pattern ^https://api\.openai\.com/ 0 20% 10080
refresh_pattern ^https://api\.hubapi\.com/ 0 20% 10080
refresh_pattern ^https://www\.googleapis\.com/ 0 20% 10080
refresh_pattern ^https://api\.anthropic\.com/ 0 20% 10080

# FTP and Gopher
refresh_pattern ^ftp: 1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440

# Dynamic content (don't cache)
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0

# Disk space settings
cache_swap_low 90
cache_swap_high 95

# Logging
access_log /usr/local/var/logs/squid/access.log squid
cache_log /usr/local/var/logs/squid/cache.log
cache_store_log none

# Log format with timing info
logformat squid %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt

# Error directory
error_directory /usr/local/share/squid/errors/en

# PID file
pid_filename /usr/local/var/run/squid.pid

# Disable core dumps (security)
coredump_dir /usr/local/var/cache/squid

# Memory pools
memory_pools on
memory_pools_limit 64 MB

# Performance tuning for mobile device
max_filedesc 1024
workers 2

# Don't cache these patterns
acl NO_CACHE url_regex -i \.(cgi|php|asp|aspx|jsp)$
acl NO_CACHE url_regex -i /admin
acl NO_CACHE url_regex -i /api/auth
no_cache deny NO_CACHE

# Always cache these
acl CACHE_IMAGES url_regex -i \.(gif|png|jpg|jpeg|ico|svg|webp|css|js|woff|woff2)$
cache allow CACHE_IMAGES

# Cache API responses (but respect cache-control)
acl API_RESPONSES url_regex -i ^https://api\.
cache allow API_RESPONSES

# Offline mode - serve stale content if upstream is unavailable
refresh_stale_hit 5 minutes

# Client request limits
request_header_max_size 64 KB
request_body_max_size 100 MB

# Shutdown lifetime
shutdown_lifetime 3 seconds

# Forward via header
forwarded_for delete

# Via header
via off

