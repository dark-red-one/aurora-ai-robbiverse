# Squid Caching Proxy Configuration
# Optimized for API response caching

# Basic settings
http_port 3128
cache_dir ufs /var/spool/squid 10000 16 256
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Memory settings
cache_mem 512 MB
maximum_object_size_in_memory 512 KB

# Disk settings
maximum_object_size 100 MB
cache_swap_low 90
cache_swap_high 95

# Cache settings
refresh_pattern . 0 20% 4320  # 3 days default
refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims ignore-reload
refresh_pattern -i \.(css|js)$ 1440 40% 40320 reload-into-ims

# API caching rules
refresh_pattern ^https://api\.openai\.com/ 0 20% 10080  # 7 days
refresh_pattern ^https://api\.hubapi\.com/ 0 20% 10080  # 7 days
refresh_pattern ^https://www\.googleapis\.com/ 0 20% 10080  # 7 days

# Access control
acl localnet src 10.0.0.0/24  # VPN network
acl localnet src 172.20.0.0/16  # Docker network
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# Allow local networks
http_access allow localnet
http_access allow localhost

# Deny unsafe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow all other requests
http_access allow all

# Error pages
error_directory /usr/share/squid/errors/en

# Log format
logformat squid %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt

# Cache peer (if using parent proxy)
# cache_peer parent.example.com parent 3128 0 no-query default

# Never cache these
acl NO_CACHE url_regex -i \.(cgi|php|asp|aspx|jsp)$
no_cache deny NO_CACHE

# Always cache these
acl CACHE_IMAGES url_regex -i \.(gif|png|jpg|jpeg|ico|css|js)$
cache allow CACHE_IMAGES

# Cache API responses
acl API_RESPONSES url_regex -i ^https://api\.
cache allow API_RESPONSES

# Performance tuning
client_persistent_connections on
server_persistent_connections on
forwarded_for on
via on

# Compression
reply_body_max_size 0 allow all

# Timeouts
connect_timeout 60 seconds
request_timeout 60 seconds
read_timeout 60 seconds
