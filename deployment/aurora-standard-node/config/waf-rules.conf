# Web Application Firewall (WAF) Rules for Aurora
# Implements "small window" security model

# Block common attack patterns
SecRuleEngine On
SecRule REQUEST_HEADERS:User-Agent "@contains sqlmap" "id:1001,phase:1,block,msg:'SQL Injection Tool Detected'"
SecRule REQUEST_HEADERS:User-Agent "@contains nikto" "id:1002,phase:1,block,msg:'Vulnerability Scanner Detected'"
SecRule REQUEST_HEADERS:User-Agent "@contains nmap" "id:1003,phase:1,block,msg:'Port Scanner Detected'"

# Block SQL injection attempts
SecRule ARGS "@detectSQLi" "id:2001,phase:2,block,msg:'SQL Injection Attack Detected'"
SecRule ARGS "@detectXSS" "id:2002,phase:2,block,msg:'XSS Attack Detected'"

# Block directory traversal
SecRule ARGS "@contains ../" "id:3001,phase:2,block,msg:'Directory Traversal Attempt'"
SecRule ARGS "@contains ..\\" "id:3002,phase:2,block,msg:'Directory Traversal Attempt'"

# Block command injection
SecRule ARGS "@detectCmdInjection" "id:4001,phase:2,block,msg:'Command Injection Attempt'"

# Rate limiting per IP
SecRule IP:REQUEST_COUNT "@gt 100" "id:5001,phase:1,block,msg:'Rate Limit Exceeded'"

# Block suspicious file uploads
SecRule FILES_NAMES "@contains .php" "id:6001,phase:2,block,msg:'Suspicious File Upload'"
SecRule FILES_NAMES "@contains .jsp" "id:6002,phase:2,block,msg:'Suspicious File Upload'"

# Block requests to sensitive files
SecRule REQUEST_URI "@contains /.env" "id:7001,phase:1,block,msg:'Sensitive File Access Attempt'"
SecRule REQUEST_URI "@contains /config" "id:7002,phase:1,block,msg:'Config File Access Attempt'"
SecRule REQUEST_URI "@contains /database" "id:7003,phase:1,block,msg:'Database File Access Attempt'"

# Allow Aurora API endpoints
SecRule REQUEST_URI "@beginsWith /api/" "id:8001,phase:1,pass,msg:'Aurora API Request'"
SecRule REQUEST_URI "@beginsWith /health" "id:8002,phase:1,pass,msg:'Health Check Request'"

# Log all blocked requests
SecRule REQUEST_URI "@rx .*" "id:9001,phase:1,log,msg:'Request Logged'"
